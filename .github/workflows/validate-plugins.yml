name: Validate Plugins

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate marketplace.json
        run: |
          echo "Validating marketplace manifest..."
          if command -v jq &> /dev/null; then
            cat .claude-plugin/marketplace.json | jq empty
            echo "✓ marketplace.json is valid JSON"
          else
            echo "jq not available, skipping validation"
          fi

      - name: Validate plugin manifests
        run: |
          echo "Validating plugin manifests..."
          plugin_count=0
          for plugin in plugins/*/; do
            if [ -d "$plugin" ] && [ "$plugin" != "plugins/*/" ]; then
              plugin_name=$(basename "$plugin")

              if [ -f "$plugin/.claude-plugin/plugin.json" ]; then
                echo "Validating $plugin_name..."

                if command -v jq &> /dev/null; then
                  cat "$plugin/.claude-plugin/plugin.json" | jq empty
                  echo "✓ $plugin_name plugin.json is valid"
                else
                  echo "jq not available, skipping validation"
                fi

                plugin_count=$((plugin_count + 1))
              else
                echo "⚠ $plugin_name missing plugin.json"
              fi
            fi
          done

          echo ""
          echo "Found $plugin_count plugin(s)"

      - name: Check hook scripts are executable
        run: |
          echo "Checking hook script permissions..."
          for script in plugins/*/hooks/scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ -x "$script" ]; then
                echo "✓ $script is executable"
              else
                echo "⚠ $script is not executable"
                exit 1
              fi
            fi
          done

      - name: Validate template
        run: |
          echo "Validating template structure..."

          # Check required template files
          required_files=(
            "template/.claude-plugin/plugin.json"
            "template/README.md"
            "template/CHANGELOG.md"
          )

          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file missing"
              exit 1
            fi
          done

          # Validate template plugin.json
          if command -v jq &> /dev/null; then
            cat template/.claude-plugin/plugin.json | jq empty
            echo "✓ template plugin.json is valid"
          fi
